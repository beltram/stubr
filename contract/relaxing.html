<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Relaxing - stubr</title>
        <!-- Custom HTML head -->
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../getting-started/unit-test.html"><strong aria-hidden="true">2.</strong> Getting started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting-started/unit-test.html"><strong aria-hidden="true">2.1.</strong> unit test</a></li><li class="chapter-item expanded "><a href="../getting-started/standalone.html"><strong aria-hidden="true">2.2.</strong> standalone</a></li></ol></li><li class="chapter-item expanded "><a href="../contract/index.html"><strong aria-hidden="true">3.</strong> Contract Testing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contract/producer.html"><strong aria-hidden="true">3.1.</strong> As a producer</a></li><li class="chapter-item expanded "><a href="../contract/consumer.html"><strong aria-hidden="true">3.2.</strong> As a consumer</a></li><li class="chapter-item expanded "><a href="../contract/relaxing.html" class="active"><strong aria-hidden="true">3.3.</strong> Relaxing</a></li></ol></li><li class="chapter-item expanded "><a href="../stubs/index.html"><strong aria-hidden="true">4.</strong> Writing Stubs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../stubs/request.html"><strong aria-hidden="true">4.1.</strong> Request</a></li><li class="chapter-item expanded "><a href="../stubs/response.html"><strong aria-hidden="true">4.2.</strong> Response</a></li></ol></li><li class="chapter-item expanded "><a href="../recording/index.html"><strong aria-hidden="true">5.</strong> Recording</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../recording/actix.html"><strong aria-hidden="true">5.1.</strong> Actix</a></li><li class="chapter-item expanded "><a href="../recording/cli.html"><strong aria-hidden="true">5.2.</strong> Cli</a></li><li class="chapter-item expanded "><a href="../recording/isahc.html"><strong aria-hidden="true">5.3.</strong> isahc</a></li><li class="chapter-item expanded "><a href="../recording/reqwest.html"><strong aria-hidden="true">5.4.</strong> reqwest</a></li><li class="chapter-item expanded "><a href="../recording/standalone.html"><strong aria-hidden="true">5.5.</strong> standalone</a></li></ol></li><li class="chapter-item expanded "><a href="../cli.html"><strong aria-hidden="true">6.</strong> Cli</a></li><li class="chapter-item expanded "><a href="../docker.html"><strong aria-hidden="true">7.</strong> Docker</a></li><li class="chapter-item expanded "><a href="../benchmark.html"><strong aria-hidden="true">8.</strong> Benchmark</a></li><li class="chapter-item expanded "><a href="../ide-completion.html"><strong aria-hidden="true">9.</strong> IDE completion</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">stubr</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="relaxing-your-stubs"><a class="header" href="#relaxing-your-stubs">Relaxing your stubs</a></h1>
<p>Whenever you are maintaining a large cohort of interconnected services, you more often than not will opt for Test Data
e.g. a user with firstname <code>john</code> and lastname <code>doe</code>. And then use this same sample user in all your services tests.
That works actually quite well. That's actually what we did previously, for example</p>
<details open="true">
<summary><b>in this stub</b></summary>
<pre><code class="language-json">{
  &quot;request&quot;: {
    &quot;method&quot;: &quot;POST&quot;,
    &quot;urlPath&quot;: &quot;/beers&quot;,
    &quot;headers&quot;: {
      &quot;content-type&quot;: {
        &quot;equalTo&quot;: &quot;application/json&quot;
      }
    },
    &quot;bodyPatterns&quot;: [
      {
        &quot;equalToJson&quot;: {
          &quot;name&quot;: &quot;Heineken&quot;,
          &quot;price&quot;: 4
        }
      }
    ]
  },
  &quot;response&quot;: {
    &quot;status&quot;: 201,
    &quot;jsonBody&quot;: {
      &quot;id&quot;: 2,
      &quot;name&quot;: &quot;Heineken&quot;,
      &quot;price&quot;: 4
    },
    &quot;headers&quot;: {
      &quot;content-type&quot;: &quot;application/json&quot;
    }
  }
}
</code></pre>
</details>
<p>With such a stub, we can imagine we would end up with a test in our consumer like that:</p>
<pre><code class="language-rust no_run noplayground">#[test]
#[stubr::apps(&quot;actix-producer&quot;)]
fn create_should_create_one() {
    let uri: String = actix_producer.uri();
    reqwest::blocking::Client::new().post(format!(&quot;{uri}/beers&quot;))
        .json(&amp;json!({
            &quot;name&quot;: &quot;Heineken&quot;,
            &quot;price&quot;: 4
        })).send()
        .expect_status_created()
        .expect_content_type_json()
        .expect_body_json(|beer: serde_json::Value| {
            assert!(beer.get(&quot;name&quot;).unwrap().is_string());
            assert!(beer.get(&quot;price&quot;).unwrap().is_u64());
        });
}</code></pre>
<p>Notice the request data in this test. Here, this sample is really dummy but in a real application, <code>name</code> is likely to
come from the consumer's own Test Data. But it cannot be any value ; remember, the producer API requires <code>name</code> to be
unique. So both producer and consumer Test Data, are now tightly coupled. We are also having specific expectations
regarding the response, for example we are expecting the beer name to be <code>Heineken</code> and its price <code>4</code> (in this situation
you could also relax your test, but sometimes you can't). And in a big system, your consumer is probably also a
producer, so all its stubs are also going to contain <code>Heineken</code> and <code>4</code>.</p>
<h2 id="when-things-change"><a class="header" href="#when-things-change">When things change</a></h2>
<p>Things always change. Sometimes, their format does, for example our beer price can change from <del><code>4</code></del> to <code>&quot;4.00&quot;</code> ;
that's fine, contract testing is made to catch those changes. But imagine if, for whatever functional reason, now prices
in your system can no longer contain 0 cent by needs to be 99 cent: all your Test Data have to change. Now imagine your
system is made of hundreds of microservices, all requiring this beer service. That's a shame, and all because some Test
Data in a single service has changed.</p>
<p>This could have been avoided if we had taken some time to make our stubs relax its request expectation and also return
randomized response data.</p>
<h2 id="relaxing-fields"><a class="header" href="#relaxing-fields">Relaxing fields</a></h2>
<p>Here we will get rid of all the hardcoded data in the response (currently there are not enough helpers to also relax
the request data with stubr, but it will be possible one day).</p>
<p>We will first randomize the id with <a href="../stubs/response.html#relaxed-field">anyU32</a>. On the consumer side, this will
generate a random <code>u32</code>. On the producer side in the <a href="producer.html#verify">verifier tests</a>, it simply asserts that the
field is a <code>u32</code>.</p>
<p>Now, for the other fields, those are directly taken from the request, so we'll
use <a href="../stubs/response.html#response-templating">response templating helpers</a> to forward them from the request.</p>
<p>We end up with a stub like this:</p>
<pre><code class="language-json">{
  &quot;request&quot;: {
    &quot;method&quot;: &quot;POST&quot;,
    &quot;urlPath&quot;: &quot;/beers&quot;,
    &quot;headers&quot;: {
      &quot;content-type&quot;: {
        &quot;equalTo&quot;: &quot;application/json&quot;
      }
    },
    &quot;bodyPatterns&quot;: [
      {
        &quot;equalToJson&quot;: {
          &quot;name&quot;: &quot;Heineken&quot;,
          &quot;price&quot;: 4
        }
      }
    ]
  },
  &quot;response&quot;: {
    &quot;status&quot;: 201,
    &quot;jsonBody&quot;: {
      &quot;id&quot;: &quot;{{anyI32}}&quot;,
      &quot;name&quot;: &quot;{{jsonPath request.body '$.name'}}&quot;,
      &quot;price&quot;: &quot;{{jsonPath request.body '$.price'}}&quot;
    },
    &quot;headers&quot;: {
      &quot;content-type&quot;: &quot;application/json&quot;
    },
    &quot;transformers&quot;: [&quot;response-template&quot;]
  }
}
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../contract/consumer.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../stubs/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../contract/consumer.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../stubs/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script>
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>
        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../mermaid.min.js"></script>
        <script src="../mermaid-init.js"></script>
    </body>
</html>
